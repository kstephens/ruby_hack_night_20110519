#!/usr/bin/env ruby
require 'pp'

filters = ARGV.dup
file_changes = { }
dir_changes = { }
verbose = false
cmd = "git log --pretty=format:'%h | %ad | %s | %d | %an' --date=short --name-only"

def add_current_dir file_name
  file_name = "./#{file_name}" unless file_name =~ %r{/}
  file_name
end

lines = 0
File.popen(cmd, "r") do | f |
  until f.eof? # commits loop:
    line = f.readline.chomp!; lines += 1
    puts "read line #{lines}: #{line.inspect}" if verbose
    commit_id, date, comment, branch_info, user = line.split(' | ')
    if verbose
      puts "  commit_id = #{commit_id.inspect}"
      puts "  date = #{date.inspect}"
      puts "  comment = #{comment.inspect}"
      puts "  user = #{user.inspect}"
    end
    until f.eof? # files in commit loop:
      line = f.readline.chomp!; lines += 1
      break if line.empty?
      puts "read line #{lines}: #{line.inspect}" if verbose
      file_name = line
      file_name = add_current_dir file_name
      file_changes[file_name] ||= 0
      file_changes[file_name] += 1

      dir_name = File.dirname(file_name)
      dir_changes[dir_name] ||= 0
      dir_changes[dir_name] += 1
    end
  end
end

def print_totals hash, title, filters
  title_printed = false
  hash.keys.sort.each do | name |
    unless filters.empty?
      next unless filters.any? { | f | f === name }
    end
    n = hash[name]
    unless title_printed
      puts "#{title}:" 
      title_printed = true
    end
    puts '%6d %s' % [ n, name ]
  end
end

#puts "filters = #{filters.inspect}" if verbose
filters.map! do | f | 
  f = add_current_dir f
  if f[-1, 1] == '/'
    f = %r{\A#{Regexp.escape(f)}}
  end
  f
end
puts "filters = #{filters.inspect}" if verbose
print_totals file_changes, "Changes by file", filters
print_totals dir_changes, "Changes by directory", filters

